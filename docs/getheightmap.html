---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "03_getheightmap.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_getheightmap.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="bwareaopen" class="doc_header"><code>bwareaopen</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>bwareaopen</code>(<strong><code>image</code></strong>, <strong><code>sz</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="bg_subtraction" class="doc_header"><code>bg_subtraction</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L32" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>bg_subtraction</code>(<strong><code>colorIMg</code></strong>, <strong><code>bgColorImg</code></strong>, <strong><code>depthImg</code></strong>, <strong><code>bgDepthImg</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="project_depth2camera" class="doc_header"><code>project_depth2camera</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L54" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>project_depth2camera</code>(<strong><code>camIntrinsics</code></strong>, <strong><code>camPose</code></strong>, <strong><code>depthImg</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="points2world" class="doc_header"><code>points2world</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L67" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>points2world</code>(<strong><code>camPose</code></strong>, <strong><code>camPts</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="getgridmapping" class="doc_header"><code>getgridmapping</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L75" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>getgridmapping</code>(<strong><code>worldPts</code></strong>, <strong><code>binMiddleBottom</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="getheightmapColor" class="doc_header"><code>getheightmapColor</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>getheightmapColor</code>(<strong><code>gridMapping</code></strong>, <strong><code>colorIMg</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="heightmapwithbgsubtraction" class="doc_header"><code>heightmapwithbgsubtraction</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L128" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>heightmapwithbgsubtraction</code>(<strong><code>gridMapping</code></strong>, <strong><code>fgMask</code></strong>, <strong><code>depthImg</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="FixMissingDepth2camera" class="doc_header"><code>FixMissingDepth2camera</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L181" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>FixMissingDepth2camera</code>(<strong><code>depthImg</code></strong>, <strong><code>bgDepthImg</code></strong>, <strong><code>camIntrinsics</code></strong>, <strong><code>camPose</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="getMissingdepthheightmap" class="doc_header"><code>getMissingdepthheightmap</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L210" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>getMissingdepthheightmap</code>(<strong><code>binMiddleBottom</code></strong>, <strong><code>missingCamPtsworldPts</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="denoiseheightmap" class="doc_header"><code>denoiseheightmap</code><a href="https://github.com/ARG-NCTU/handover_grasping/tree/{branch}/handover_grasping/getheightmap.py#L279" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>denoiseheightmap</code>(<strong><code>heightMap</code></strong>, <strong><code>noisePix</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Load data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/home/arg/handover_grasping/multi_view/Zeng&#39;</span>
<span class="n">ColorIMg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/color-input/000000-0.png&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">255.0</span>
<span class="n">ColorIMg</span> <span class="o">=</span> <span class="n">ColorIMg</span><span class="p">[:,:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">DepthImg</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/depth-input/000000-0.png&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">10000.0</span>
<span class="n">BgColorImg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/color-background/000000-0.png&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">255.0</span>
<span class="n">BgColorImg</span> <span class="o">=</span> <span class="n">BgColorImg</span><span class="p">[:,:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">BgDepthImg</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/depth-background/000000-0.png&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">10000.0</span>
<span class="n">CamIntrinsics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/camera-intrinsics/000000-0.txt&#39;</span><span class="p">)</span>

<span class="n">CamPose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/camera-pose/000000-0.txt&#39;</span><span class="p">)</span>
<span class="n">BinMiddleBottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/bin-position.txt&#39;</span><span class="p">)</span>
<span class="n">BinMiddleBottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">BinMiddleBottom</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Do background subtraction</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">FgMaskColor</span><span class="p">,</span> <span class="n">FgMask</span> <span class="o">=</span> <span class="n">bg_subtraction</span><span class="p">(</span><span class="n">ColorIMg</span><span class="p">,</span> <span class="n">BgColorImg</span><span class="p">,</span> <span class="n">DepthImg</span><span class="p">,</span> <span class="n">BgDepthImg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Project depth into camera space</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">CamPts</span> <span class="o">=</span> <span class="n">project_depth2camera</span><span class="p">(</span><span class="n">CamIntrinsics</span><span class="p">,</span> <span class="n">CamPose</span><span class="p">,</span> <span class="n">DepthImg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Transform points to world coordinates</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">WorldPts</span> <span class="o">=</span> <span class="n">points2world</span><span class="p">(</span><span class="n">CamPose</span><span class="p">,</span> <span class="n">CamPts</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get height map</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">GridMapping</span> <span class="o">=</span> <span class="n">getgridmapping</span><span class="p">(</span><span class="n">WorldPts</span><span class="p">,</span> <span class="n">BinMiddleBottom</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Compute height map color</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">HeightMapColor</span> <span class="o">=</span> <span class="n">getheightmapColor</span><span class="p">(</span><span class="n">GridMapping</span><span class="p">,</span> <span class="n">ColorIMg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Compute real height map with background subtraction</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">HeightMap</span> <span class="o">=</span> <span class="n">heightmapwithbgsubtraction</span><span class="p">(</span><span class="n">GridMapping</span><span class="p">,</span> <span class="n">FgMask</span><span class="p">,</span> <span class="n">DepthImg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Find missing depth and project background depth into camera space</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">MissingDepth</span><span class="p">,</span> <span class="n">MissingCamPts</span><span class="p">,</span> <span class="n">MissingCamPtsworldPts</span> <span class="o">=</span> <span class="n">FixMissingDepth2camera</span><span class="p">(</span><span class="n">DepthImg</span><span class="p">,</span> <span class="n">BgDepthImg</span><span class="p">,</span> <span class="n">CamIntrinsics</span><span class="p">,</span> <span class="n">CamPose</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Get missing depth height map</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">MissingHeightMap</span><span class="p">,</span> <span class="n">NoisePix</span> <span class="o">=</span> <span class="n">getMissingdepthheightmap</span><span class="p">(</span><span class="n">BinMiddleBottom</span><span class="p">,</span> <span class="n">MissingCamPtsworldPts</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Denoise height map</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">HeightMap</span> <span class="o">=</span> <span class="n">denoiseheightmap</span><span class="p">(</span><span class="n">HeightMap</span><span class="p">,</span> <span class="n">NoisePix</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Save result</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">grid_x</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">grid_y</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">HeightMapColor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">HeightMapColor</span><span class="p">,</span> <span class="p">(</span><span class="n">grid_x</span><span class="p">,</span><span class="n">grid_y</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
<span class="n">colorData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span><span class="mi">320</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">colorData</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">212</span><span class="p">,</span><span class="mi">10</span><span class="p">:</span><span class="mi">310</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">HeightMapColor</span><span class="p">[:,:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">colorData</span> <span class="o">=</span> <span class="n">colorData</span><span class="o">*</span><span class="mi">255</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/heightmap_color.png&#39;</span><span class="p">,</span> <span class="n">colorData</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">HeightMap</span><span class="p">[</span><span class="n">HeightMap</span><span class="o">&gt;</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">rawHeightMap</span> <span class="o">=</span> <span class="n">HeightMap</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">depthData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">224</span><span class="p">,</span><span class="mi">320</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
<span class="n">depthData</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">212</span><span class="p">,</span><span class="mi">10</span><span class="p">:</span><span class="mi">310</span><span class="p">]</span> <span class="o">=</span> <span class="n">rawHeightMap</span><span class="o">*</span><span class="mi">10000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/heightmap_depth.png&#39;</span><span class="p">,</span> <span class="n">depthData</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>True</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

